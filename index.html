<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
  <meta charset="UTF-8">
  <title>Theo dõi link</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-6">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-3xl font-bold">Theo dõi link</h2>
    <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:scale-110 transition">
      ☀️
    </button>
  </div>

  <!-- Input -->
  <div class="mb-6 space-y-3">
    <input type="email" id="email" placeholder="Nhập email nhận thông báo"
      class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring focus:ring-indigo-500">
    <textarea id="urls" placeholder="Nhập mỗi link 1 dòng"
      class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 h-28 focus:ring focus:ring-indigo-500"></textarea>
    <button onclick="addLinks()"
      class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium shadow-md flex items-center gap-2">
      ➕ Thêm link
    </button>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl shadow-md">
    <table class="min-w-full text-sm text-left border-collapse">
      <thead class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
        <tr>
          <th class="p-3">URL</th>
          <th class="p-3">Email</th>
          <th class="p-3">Coin</th>
          <th class="p-3">Trạng thái</th>
          <th class="p-3">Lần kiểm tra</th>
          <th class="p-3">Đang theo dõi</th>
          <th class="p-3">Xóa</th>
        </tr>
      </thead>
      <tbody id="statusTable" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
    </table>
  </div>

<script>
const API_URL = 'https://check-end-coin-production.up.railway.app';

// Badge trạng thái
function renderStatusBadge(status) {
  let base = "px-3 py-1 rounded-full text-xs font-semibold";
  switch (status) {
    case "Đang diễn ra":
      return `<span class="${base} bg-green-500 text-white">Đang diễn ra</span>`;
    case "Đã kết thúc":
      return `<span class="${base} bg-red-500 text-white">Đã kết thúc</span>`;
    case "Đang tính toán":
      return `<span class="${base} bg-yellow-500 text-gray-900">Đang tính toán</span>`;
    case "Không lấy được":
      return `<span class="${base} bg-gray-500 text-white animate-pulse">Không lấy được</span>`;
    default:
      return `<span class="${base} bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200">-</span>`;
  }
}

async function addLinks(){
  const email = document.getElementById('email').value.trim();
  const urls = document.getElementById('urls').value.split('\n').map(u=>u.trim()).filter(u=>u);
  if(!email) return alert("Nhập email");
  if(urls.length===0) return alert("Nhập ít nhất 1 link");

  const payload = urls.map(u=>({url:u, emails:[email]}));
  await fetch(API_URL+"/add-links",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({urls:payload})});
  document.getElementById('urls').value="";
  fetchStatus();
}

async function removeLink(url){
  if(!confirm(`Xóa link ${url}?`)) return;
  await fetch(API_URL+"/remove-link",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url})});
  fetchStatus();
}

async function promptAddEmail(url){
  const email = prompt("Nhập email mới:");
  if(!email) return;
  await fetch(API_URL+"/add-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url,email})});
  fetchStatus();
}

async function fetchStatus(){
  try{
    const res = await fetch(API_URL+"/status");
    const data = await res.json();
    const tbody = document.getElementById("statusTable");
    tbody.innerHTML = "";
    data.forEach(link=>{
      const row = `<tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
<td class="p-3">${link.url}</td>
<td class="p-3">${link.emails.map(e=>`<div class="flex items-center gap-2">${e}</div>`).join("")}
  <button class="ml-2 px-2 py-1 bg-green-500 text-white rounded-lg text-xs hover:bg-green-600" onclick="promptAddEmail('${link.url}')">➕</button>
</td>
<td class="p-3">${link.coin||""}</td>
<td class="p-3">${renderStatusBadge(link.status)}</td>
<td class="p-3">${link.lastChecked? new Date(new Date(link.lastChecked).getTime() + 7 * 60 * 60 * 1000).toLocaleString('vi-VN'):""}</td>
<td class="p-3">${link.active?"✅":"❌"}</td>
<td class="p-3">
  <button class="px-2 py-1 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600" onclick="removeLink('${link.url}')">❌</button>
</td>
</tr>`;
      tbody.innerHTML+=row;
    });
  }catch(e){console.error(e);}
}

setInterval(fetchStatus,5000);
fetchStatus();

// Theme toggle
const themeToggle = document.getElementById("themeToggle");
if (localStorage.theme === "light") {
  document.documentElement.classList.remove("dark");
  themeToggle.textContent = "🌙";
} else {
  themeToggle.textContent = "☀️";
}

themeToggle.addEventListener("click", () => {
  document.documentElement.classList.toggle("dark");
  if (document.documentElement.classList.contains("dark")) {
    localStorage.theme = "dark";
    themeToggle.textContent = "☀️";
  } else {
    localStorage.theme = "light";
    themeToggle.textContent = "🌙";
  }
});
</script>
</body>
</html>
